<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<head>
    <meta charset="UTF-8" />
    <title>Standalone Group Chat</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #f8f9fa;
            margin: 1rem;
        }

        #chatBox {
            width: 100%;
            height: 400px;
            background: #ffffff;
            border: 1px solid #ccc;
            overflow-y: auto;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .message-entry {
            margin-bottom: 0.5rem;
            line-height: 1.2;
        }

        .message-username {
            font-weight: bold;
        }

        .message-timestamp {
            font-size: 0.8rem;
            color: #777;
            margin-left: 5px;
        }

        .inputs {
            margin-bottom: 1rem;
        }

        .inputs input {
            padding: 0.5rem;
            width: 200px;
            margin-right: 5px;
        }

        button {
            padding: 0.5rem 1rem;
            cursor: pointer;
        }
          #chatBox {
        display: flex;
        flex-direction: column;
        gap: 0.8rem;
    }

    .message-entry {
        max-width: 70%;
        padding: 10px;
        border-radius: 15px;
        position: relative;
    }

    .my-message {
        background: #DCF8C6;
        align-self: flex-end;
        margin-left: 30%;
    }

    .other-message {
        background: #EAEAEA;
        align-self: flex-start;
        margin-right: 30%;
    }

    .message-timestamp {
        display: block;
        font-size: 0.75rem;
        color: #666;
        margin-top: 4px;
    }
    </style>
</head>

<body>
    <h1>Standalone Group Chat</h1>
    <nav th:replace="~{fragments/navbar :: navbar}"></nav>

    <div id="chatBox"></div>

    <div class="inputs">
<input type="text" hidden id="username" th:value="${#authentication.principal.username}" placeholder="Username" />
        <input type="text" id="message" placeholder="Your message..." />
        <button onclick="sendMessage()">Send</button>
    </div>

    <!-- SockJS + STOMP libraries -->
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs/lib/stomp.min.js"></script>

    <script>
        // Adjust this to point to your actual backend:
        // e.g., "http://localhost:8080" or "https://mydomain.com"
        const BASE_URL = 'http://localhost:7233';

        let stompClient = null;

        // 1. Load the existing messages from the REST endpoint.
        async function loadChatHistory() {
            const chatBox = document.getElementById('chatBox');
            try {
                const response = await fetch(`${BASE_URL}/api/chat/messages`);
                if (!response.ok) {
                    console.error('Failed to fetch chat history:', response.status);
                    return;
                }
                const messages = await response.json();
                // Clear existing
                chatBox.innerHTML = '';
                // Append fetched messages
                messages.forEach(msg => {
                    addMessageToUI(msg.username, msg.content, msg.timestamp.toEpochMilli());
                });
            } catch (error) {
                console.error('Error fetching chat history:', error);
            }
        }

        // 2. Connect to WebSocket using SockJS + STOMP
        function connectWebSocket() {
            // Point SockJS to your backend's STOMP endpoint
            const socket = new SockJS(`${BASE_URL}/ws`);
            stompClient = Stomp.over(socket);

            // If you want less debug logs, uncomment:
            // stompClient.debug = null;

            stompClient.connect({}, function (frame) {
                console.log('Connected:', frame);
                // Subscribe to topic
                stompClient.subscribe('/topic/group', function (messageOutput) {
                    const msgBody = JSON.parse(messageOutput.body);
                    addMessageToUI(msgBody.username, msgBody.content, msgBody.timestamp);
                });
            }, function (error) {
                console.error('STOMP error:', error);
            });
        }

        // 3. Send a new message
        function sendMessage() {
            const username = document.getElementById('username').value.trim();
            const content = document.getElementById('message').value.trim();

            if (!username || !content) {
                alert('Please enter username and message.');
                return;
            }

            // Send to /app/sendMessage on the backend
            stompClient.send('/app/sendMessage', {}, JSON.stringify({
                username: username,
                content: content
            }));

            // Clear the message input
            document.getElementById('message').value = '';
        }

        // 4. Add message to UI
        function addMessageToUI(username, content, timestamp) {
                const chatBox = document.getElementById('chatBox');
                const messageDiv = document.createElement('div');
                const currentUser = document.getElementById('username').value.trim();

                // Alignment classes
                messageDiv.classList.add('message-entry',
                    username === currentUser ? 'my-message' : 'other-message');

                // Date formatting
                let timeString = 'Now';
                if (timestamp) {
                    try {
                        const date = new Date(timestamp);
                        timeString = date.toLocaleTimeString([], {
                            hour: '2-digit',
                            minute: '2-digit',
                            hour12: true
                        });
                    } catch (e) {
                        console.warn('Using fallback timestamp');
                    }
                }

                messageDiv.innerHTML = `
        <span class="message-username">${username}</span>
        <div class="message-content">${content}</div>
        <span class="message-timestamp">${timeString}</span>
    `;

                chatBox.appendChild(messageDiv);
                chatBox.scrollTop = chatBox.scrollHeight;
            }
        // On page load
        window.addEventListener('load', () => {
            loadChatHistory();
            connectWebSocket();
        });
    </script>
</body>

</html>